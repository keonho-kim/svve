# Vtree Search 이론 배경 (큐잉/저지연 관점)

## 관련 문서

- [프로젝트 개요](../../README.md)
- [아키텍처 청사진](./blueprint.md)
- [런타임 동작](./how-this-works.md)
- [운영 가이드](../ops/queueing-and-slo.md)

## 1. 문제

멀티모달 검색은 다음 병목을 동시에 가진다.

- 벡터/트리 조회의 DB 병목
- LLM 필터/주석 호출의 외부 모델 지연
- 동시 요청 급증 시 tail latency 급상승

따라서 검색 정확도뿐 아니라 **부하 제어 이론**이 필수다.

## 2. 큐잉 모델

- 입력 요청을 Stream으로 직렬화
- 소비자는 bounded concurrency로 실행
- 처리 보장 모델은 At-least-once

이때 안정 조건은 다음과 같다.

- 평균 도착률 `λ` < 평균 처리율 `μ`를 유지
- `λ` 급증 구간에서는 조기 거절(429 매핑)로 `Wq`(대기 시간) 폭증을 방지

## 3. 저지연 우선 전략

1. 큐 길이 기반 admission control
2. 워커 동시성 상한 (`min(4, CPU)`)
3. 재시도 횟수 상한(3회)
4. DLQ 분리로 hot path 보호
5. LLM 인터페이스 위반 즉시 실패로 불확실성 제거

## 4. 품질-성능 트레이드오프

- 재시도를 늘리면 성공률은 올라가지만 대기열 압력이 커진다.
- 큐 거절 임계치를 낮추면 지연은 낮아지지만 거절률이 올라간다.
- 프롬프트를 길게 만들면 품질은 좋아질 수 있지만 토큰 지연이 증가한다.
- 본 설계는 초기 운영 안정성을 위해 저지연/보수적 임계치를 택한다.

## 5. 결론

Vtree Search의 핵심은 검색 알고리즘 자체만이 아니라,
**큐잉+재시도+DLQ+명시적 실패 시맨틱**을 포함한 운영 가능한 라이브러리 설계다.
